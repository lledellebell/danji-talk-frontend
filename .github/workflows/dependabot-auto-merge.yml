name: Dependabot ìë™ ë³‘í•©

on:
  pull_request:
    branches: ['master', 'develop']

# ì›Œí¬í”Œë¡œìš° ê°„ ê¶Œí•œì„ ì œí•œí•©ë‹ˆë‹¤
permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot-auto-merge:
    name: Dependabot PR ìë™ ë³‘í•©
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: Dependabot ë©”íƒ€ë°ì´í„° ì¡°íšŒ
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Patch & Minor ì—…ë°ì´íŠ¸ ìë™ ìŠ¹ì¸ ë° ë³‘í•©
        if: ${{
          steps.metadata.outputs.update-type == 'version-update:semver-patch' || 
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        }}
        run: |
          gh pr review --approve "$PR_URL"
          
          # íŒ¨ì¹˜ ì—…ë°ì´íŠ¸ëŠ” ì¦‰ì‹œ ë³‘í•©
          if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            gh pr merge --auto --merge "$PR_URL"
          # ë§ˆì´ë„ˆ ì—…ë°ì´íŠ¸ëŠ” CIê°€ ì„±ê³µí•˜ë©´ ë³‘í•©
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
            gh pr merge --auto --merge "$PR_URL"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ë³´ì•ˆ ì—…ë°ì´íŠ¸ëŠ” íŠ¹ë³„íˆ ë¹ ë¥´ê²Œ ì²˜ë¦¬
      - name: ë³´ì•ˆ ì—…ë°ì´íŠ¸ ìë™ ìŠ¹ì¸ ë° ë³‘í•©
        if: ${{ steps.metadata.outputs.security-severity == 'high' || steps.metadata.outputs.security-severity == 'critical' }}
        run: |
          echo "ğŸ” ë†’ì€ ì‹¬ê°ë„ì˜ ë³´ì•ˆ ì—…ë°ì´íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë³‘í•©í•©ë‹ˆë‹¤"
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 