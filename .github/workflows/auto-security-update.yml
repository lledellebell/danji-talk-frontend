name: ìë™ ë³´ì•ˆ ì—…ë°ì´íŠ¸

on:
  # ë§¤ì¼ ìì •ì— ì‹¤í–‰
  schedule:
    - cron: '0 0 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  auto-security-update:
    name: ìë™ ë³´ì•ˆ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci || npm install

      # ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
      - name: ë³´ì•ˆ ì·¨ì•½ì  ê°ì‚¬
        id: audit
        run: |
          npm audit --json > npm-audit.json || true
          # ì·¨ì•½ì ì´ ìˆëŠ”ì§€ í™•ì¸
          if grep -q '"vulnerabilities":{}' npm-audit.json || grep -q '"vulnerabilities": {}' npm-audit.json; then
            echo "HAS_VULNERABILITIES=false" >> $GITHUB_ENV
            echo "âœ… ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "HAS_VULNERABILITIES=true" >> $GITHUB_ENV
            echo "âš ï¸ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

      # ì·¨ì•½ì ì´ ìˆì„ ê²½ìš°ì—ë§Œ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
      - name: ë³´ì•ˆ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
        if: env.HAS_VULNERABILITIES == 'true'
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘..."
          
          # 1. ìë™ ì—…ë°ì´íŠ¸ ì‹œë„
          npm audit fix --force || true
          
          # 2. axios ì—…ë°ì´íŠ¸ (SSRF ë° Credential Leakage)
          npm install axios@latest --save || true
          
          # 3. vite ê´€ë ¨ ì—…ë°ì´íŠ¸ (server.fs.deny ìš°íšŒ ì·¨ì•½ì )
          npm install vite@latest --save-dev || true
          npm install @vitejs/plugin-react@latest --save-dev || true
          
          # 4. ì˜ì¡´ì„± ì •ë¦¬
          npm dedupe || true
      
      # ë³€ê²½ ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: verify-changes
        run: |
          git diff --quiet package.json package-lock.json || echo "CHANGES=true" >> $GITHUB_ENV

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: env.CHANGES == 'true'
        run: |
          # Git ì„¤ì •
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ì‘ì—… ë¸Œëœì¹˜ ìƒì„±
          git checkout -b auto-security-update-$(date +%Y%m%d%H%M%S)
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add package.json package-lock.json
          git commit -m "ë³´ì•ˆ: ì·¨ì•½ íŒ¨í‚¤ì§€ ìë™ ì—…ë°ì´íŠ¸"

      # í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
      - name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ
        if: env.CHANGES == 'true'
        run: |
          npm run build || echo "ë¹Œë“œ ê²½ê³ ê°€ ìˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."

      # ìë™ PR ìƒì„± ë° ë³‘í•©
      - name: PR ìƒì„± ë° ìë™ ë³‘í•©
        if: env.CHANGES == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ë³´ì•ˆ: ì·¨ì•½ íŒ¨í‚¤ì§€ ìë™ ì—…ë°ì´íŠ¸"
          branch: auto-security-update
          delete-branch: true
          title: "ë³´ì•ˆ: ì·¨ì•½ íŒ¨í‚¤ì§€ ìë™ ì—…ë°ì´íŠ¸"
          body: |
            ## ğŸ”’ ìë™ ë³´ì•ˆ ì—…ë°ì´íŠ¸
            
            ì´ PRì€ ë³´ì•ˆ ì·¨ì•½ì ì´ ìˆëŠ” íŒ¨í‚¤ì§€ë¥¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            
            ### ì—…ë°ì´íŠ¸ëœ íŒ¨í‚¤ì§€:
            - npm audit ê²°ê³¼ì— ë”°ë¥¸ ìë™ ì—…ë°ì´íŠ¸
            - axios: SSRF ë° Credential Leakage ì·¨ì•½ì  ìˆ˜ì •
            - vite: server.fs.deny ìš°íšŒ ê´€ë ¨ ì·¨ì•½ì  ìˆ˜ì •
            
            ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìœ¼ë©°, í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ë©´ ìë™ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.
          base: master
          labels: security,dependencies,automated-pr
      
      # ìë™ ë³‘í•© í™œì„±í™”
      - name: ìë™ ë³‘í•© í™œì„±í™”
        if: env.CHANGES == 'true'
        run: |
          PR_URL=$(gh pr list --state open --label automated-pr --json url --jq '.[0].url')
          if [ -n "$PR_URL" ]; then
            PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]*$')
            echo "PR #$PR_NUMBERì— ìë™ ë³‘í•© í™œì„±í™”"
            gh pr merge $PR_NUMBER --auto --merge
          else
            echo "PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 